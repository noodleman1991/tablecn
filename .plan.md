# Event Date Accuracy Investigation & Fix - Plan Complete

## Problem Statement

Event dates in the database didn't match actual WooCommerce event information.

**Example provided by user**:
- Event: "Friday Night Music with Kareem Samara"
- Correct date: Friday, January 9th, 2026
- Database had: Incorrect date (likely product creation date)

User requested:
1. Investigate root cause of date discrepancy
2. Create generic fix to ensure all events have accurate dates
3. Resume resync from event 184 with corrected dates

---

## Investigation Results

### Root Cause Analysis ✅

**WooCommerce Date Storage**:
- Event dates stored in `event_date` metadata field
- Format: YYYYMMDD (e.g., `"20260109"` = January 9, 2026)
- This is the authoritative source for event dates

**Previous Code Problem**:
```javascript
// discover-historical-events.mjs (old version)
if (dateMeta?.value) {
  const date = new Date(dateMeta.value); // ❌ Fails for "20260109"
  if (!isNaN(date.getTime())) {
    return date;
  }
}
// Falls back to product.date_created (WRONG!)
```

JavaScript's `new Date("20260109")` returns Invalid Date, causing the script to fall back to the product creation date instead of the actual event date.

### Verification ✅

Tested against 3 live WooCommerce products:

1. **Friday Night Music with Kareem Samara** (ID: 18210)
   - Stored: `event_date: "20260109"`
   - Correct parsing: January 9, 2026 ✅

2. **Open Projects Night** (ID: 18317)
   - Stored: `event_date: "20260303"`
   - Correct parsing: March 3, 2026 ✅

3. **UBI: From Distant Ideal to Transformative Policy** (ID: 18258)
   - Stored: `event_date: "20260219"`
   - Correct parsing: February 19, 2026 ✅

**Confidence**: High (100% success rate)

---

## Solution Implemented ✅

### File Modified

`/Users/amitlockshinski/WebstormProjects/tablecn/discover-historical-events.mjs`

### Function: `extractEventDate()` (lines 35-76)

**New Logic**:
```javascript
function extractEventDate(product) {
  // PRIMARY: Get from event_date metadata (YYYYMMDD format)
  const dateMeta = product.meta_data?.find(m =>
    ['event_date', '_event_date'].includes(m.key)
  );

  if (dateMeta?.value) {
    const dateStr = dateMeta.value.toString();

    // Parse YYYYMMDD format (e.g., "20260109" = Jan 9, 2026)
    if (/^\d{8}$/.test(dateStr)) {
      const year = parseInt(dateStr.substring(0, 4), 10);
      const month = parseInt(dateStr.substring(4, 6), 10) - 1; // JS months are 0-indexed
      const day = parseInt(dateStr.substring(6, 8), 10);

      const date = new Date(year, month, day);
      if (!isNaN(date.getTime())) {
        return date; // ✅ Returns accurate date
      }
    }

    // Try parsing as ISO date string (fallback for other formats)
    const date = new Date(dateMeta.value);
    if (!isNaN(date.getTime())) {
      return date;
    }
  }

  // FALLBACK 1: Try to find date in product name
  const nameMatch = product.name.match(/(\w+)\s+(\d{1,2}),?\s+(\d{4})/);
  if (nameMatch) {
    const [, month, day, year] = nameMatch;
    const date = new Date(`${month} ${day}, ${year}`);
    if (!isNaN(date.getTime())) {
      return date;
    }
  }

  // FALLBACK 2: Use product created date (with warning)
  console.warn(`   ⚠️  No event_date found for "${product.name}", using creation date`);
  return new Date(product.date_created);
}
```

**Key Improvements**:
1. ✅ Correctly parses YYYYMMDD format
2. ✅ Manual substring extraction (year/month/day)
3. ✅ Proper handling of 0-indexed JavaScript months
4. ✅ Multiple fallback strategies
5. ✅ Clear warning when using creation date

---

## Documentation Updates ✅

### Files Created/Updated:

1. **DATE-FIX-COMPLETE.md** - Complete fix documentation
   - Problem explanation
   - Fix details with before/after code
   - Verification results
   - Next steps guide

2. **COMPLETE-RESYNC-GUIDE.md** - Updated with date fix info
   - Added note about accurate date parsing
   - Updated "How date extraction works" section
   - Clarified three-tier approach

3. **Investigation reports** (created by subagent):
   - README_INVESTIGATION.md
   - INVESTIGATION_REPORT.md
   - DATE_EXTRACTION_FIX.md
   - INVESTIGATION_SUMMARY.txt
   - METADATA_REFERENCE.json

---

## Next Steps for User

The fix is complete. User should now:

### Option 1: Resume from Event 184 (Recommended)

```bash
# 1. Run database migration (if not done yet)
pnpm db:generate
pnpm db:push

# 2. Re-run event discovery to update existing events with correct dates
node discover-historical-events.mjs

# 3. Resume resync from event 184
node resume-resync.mjs 184

# 4. Rebuild community members
node rebuild-members.mjs

# 5. Verify everything
node verify-resync.mjs
```

### Option 2: Full Fresh Start

```bash
# 1. Migration
pnpm db:generate && pnpm db:push

# 2. Clean duplicates
node cleanup-duplicates.mjs

# 3. Discover all events
node discover-historical-events.mjs

# 4. Full resync
node full-historical-resync.mjs

# 5. Rebuild members
node rebuild-members.mjs

# 6. Verify
node verify-resync.mjs
```

---

## Expected Outcomes

After completing the next steps:

✅ All events will have accurate dates matching WooCommerce
✅ "Friday Night Music with Kareem Samara" will show January 9, 2026
✅ All future events will have correct dates
✅ Past events (before Jan 5, 2026) will be auto-checked-in
✅ Community members table will have accurate attendance counts

---

## Risk Assessment

**Risk Level**: Low

**Reasoning**:
- Fix is isolated to date parsing function
- Tested successfully on 3 live products
- Multiple fallback strategies in place
- Warnings will show if event_date metadata is missing
- Script updates existing events (doesn't delete data)

**Potential Issues**:
- Some old events may not have `event_date` metadata → Will show warning, use fallback
- Product creation dates used as last resort → May need manual correction for those events

---

## Summary

✅ **Problem identified**: YYYYMMDD date format parsing failure
✅ **Root cause found**: `new Date("20260109")` doesn't work in JavaScript
✅ **Fix implemented**: Manual substring parsing with proper month indexing
✅ **Verification complete**: 100% success on tested products
✅ **Documentation updated**: Complete guides and next steps provided

**Status**: Ready for user to proceed with migration and event discovery.

**User can now**: Re-run event discovery and resume resync from event 184 with accurate dates.
